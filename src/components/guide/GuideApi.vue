<template>
  <div class="space-y-12 max-w-5xl pb-32">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">API & Data Fetching ì•„í‚¤í…ì²˜</h2>

      <p class="mt-2 text-gray-600">
        ë³¸ ìŠ¤íƒ€íŠ¸í‚·ì€ <strong>Ofetch</strong>ì™€ <strong>TanStack Query</strong>ê°€ ìµœì ì˜ ìƒíƒœë¡œ
        ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br />
        <strong>Key Factory Pattern</strong>ì„ í†µí•´ ìºì‹œ í‚¤ë¥¼ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•˜ê³  ì˜ì¡´ì„±ì„
        ìµœì†Œí™”í•©ë‹ˆë‹¤.
      </p>
    </div>

    <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
      <div class="flex">
        <div class="shrink-0">
          <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
            <path
              fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
              clip-rule="evenodd"
            />
          </svg>
        </div>

        <div class="ml-3">
          <p class="text-sm text-blue-700">
            <strong>Auto Import ì•Œë¦¼:</strong><br />
            ì•„ë˜ ì˜ˆì‹œ ì½”ë“œì—ëŠ” <code>import</code> êµ¬ë¬¸ì´ ìƒëµë˜ì–´ ìˆìŠµë‹ˆë‹¤. <br />
            <code>ref</code>, <code>useQuery</code> ë“± ë¼ì´ë¸ŒëŸ¬ë¦¬ ì½”ì–´ í•¨ìˆ˜ëŠ” ì„¤ì •ì— ì˜í•´ ìë™ìœ¼ë¡œ
            ì£¼ì…ë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    </div>

    <section class="space-y-4">
      <div class="flex items-center gap-2">
        <span class="bg-indigo-100 text-indigo-700 font-bold px-2 py-1 rounded text-sm"
          >STEP 1</span
        >

        <h3 class="text-xl font-bold text-gray-800">API í•¨ìˆ˜ ì •ì˜ (Api Layer)</h3>
      </div>

      <p class="text-gray-600 text-sm">
        <code>src/api/modules</code> í´ë”ì— ë„ë©”ì¸ë³„ í†µì‹  í•¨ìˆ˜ë¥¼ ë§Œë“­ë‹ˆë‹¤. íŒŒë¼ë¯¸í„°(Params/Query)ë¥¼
        ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
      </p>

      <div class="bg-[#1e1e1e] rounded-lg shadow-xl border border-gray-800 font-mono text-sm">
        <div class="flex items-center px-4 py-2 bg-[#252526] border-b border-gray-800">
          <div class="flex gap-1.5 mr-4">
            <div class="w-3 h-3 rounded-full bg-[#ff5f56]"></div>

            <div class="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>

            <div class="w-3 h-3 rounded-full bg-[#27c93f]"></div>
          </div>
          <span class="text-gray-400">src/api/modules/users.ts</span>
        </div>

        <pre
          class="p-4 overflow-x-auto leading-relaxed text-[#d4d4d4]"
        ><code><span class="text-[#c586c0]">import</span> { <span class="text-[#9cdcfe]">request</span> } <span class="text-[#c586c0]">from</span> <span class="text-[#ce9178]">'@/api/request'</span>

<span class="text-[#6a9955]">// íŒŒë¼ë¯¸í„°ë¥¼ ë°›ì•„ params ê°ì²´ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤ (URL ì¸ì½”ë”© ìë™ ì²˜ë¦¬)</span>
<span class="text-[#c586c0]">export</span> <span class="text-[#569cd6]">const</span> <span class="text-[#dcdcaa]">fetchUsers</span> = (<span class="text-[#9cdcfe]">page</span>: <span class="text-[#4ec9b0]">number</span>, <span class="text-[#9cdcfe]">status</span>?: <span class="text-[#4ec9b0]">string</span>) <span class="text-[#569cd6]">=&gt;</span> {
  <span class="text-[#c586c0]">return</span> <span class="text-[#dcdcaa]">request</span>&lt;<span class="text-[#4ec9b0]">User</span>[]&gt;(<span class="text-[#ce9178]">'/users'</span>, {
    <span class="text-[#9cdcfe]">query</span>: { <span class="text-[#9cdcfe]">page</span>, <span class="text-[#9cdcfe]">status</span> }
  })
}

<span class="text-[#c586c0]">export</span> <span class="text-[#569cd6]">const</span> <span class="text-[#dcdcaa]">createUser</span> = (<span class="text-[#9cdcfe]">data</span>: <span class="text-[#4ec9b0]">Partial</span>&lt;<span class="text-[#4ec9b0]">User</span>&gt;) <span class="text-[#569cd6]">=&gt;</span> {
  <span class="text-[#c586c0]">return</span> <span class="text-[#dcdcaa]">request</span>&lt;<span class="text-[#4ec9b0]">User</span>&gt;(<span class="text-[#ce9178]">'/users'</span>, {
    <span class="text-[#9cdcfe]">method</span>: <span class="text-[#ce9178]">'POST'</span>,
    <span class="text-[#9cdcfe]">data</span>
  })
}</code></pre>
      </div>
    </section>

    <section class="space-y-4">
      <div class="flex items-center gap-2">
        <span class="bg-indigo-100 text-indigo-700 font-bold px-2 py-1 rounded text-sm"
          >STEP 2</span
        >

        <h3 class="text-xl font-bold text-gray-800">
          Query Hook & Key Factory (src/composables/queries)
        </h3>
      </div>

      <p class="text-gray-600 text-sm">
        API í˜¸ì¶œì„ ê°ì‹¸ëŠ” Custom Hookì„ ë§Œë“­ë‹ˆë‹¤. <strong>Key Factory Pattern</strong>ì„ ì ìš©í•˜ì—¬
        ìºì‹œ í‚¤ë¥¼ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•©ë‹ˆë‹¤.
      </p>

      <div class="bg-[#1e1e1e] rounded-lg shadow-xl border border-gray-800 font-mono text-sm">
        <div class="flex items-center px-4 py-2 bg-[#252526] border-b border-gray-800">
          <div class="flex gap-1.5 mr-4">
            <div class="w-3 h-3 rounded-full bg-[#ff5f56]"></div>

            <div class="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>

            <div class="w-3 h-3 rounded-full bg-[#27c93f]"></div>
          </div>
          <span class="text-gray-400">src/composables/queries/useUserQueries.ts</span>
        </div>

        <pre
          class="p-4 overflow-x-auto leading-relaxed text-[#d4d4d4]"
        ><code><span class="text-[#c586c0]">import</span> { <span class="text-[#9cdcfe]">fetchUsers</span>, <span class="text-[#9cdcfe]">createUser</span> } <span class="text-[#c586c0]">from</span> <span class="text-[#ce9178]">'@/api/modules/users'</span>
<span class="text-[#c586c0]">import</span> <span class="text-[#569cd6]">type</span> { <span class="text-[#4ec9b0]">Ref</span> } <span class="text-[#c586c0]">from</span> <span class="text-[#ce9178]">'vue'</span>

<span class="text-[#6a9955]">// 1. Key Factory Pattern (ë°°ì—´ í˜•íƒœì˜ í™•ì¥ ê°€ëŠ¥í•œ í‚¤ êµ¬ì¡°)</span>
<span class="text-[#c586c0]">export</span> <span class="text-[#569cd6]">const</span> <span class="text-[#4fc1ff]">userKeys</span> = {
  <span class="text-[#9cdcfe]">all</span>: [<span class="text-[#ce9178]">'users'</span>] <span class="text-[#569cd6]">as const</span>,
  <span class="text-[#dcdcaa]">lists</span>: () <span class="text-[#569cd6]">=&gt;</span> [...<span class="text-[#4fc1ff]">userKeys</span>.<span class="text-[#9cdcfe]">all</span>, <span class="text-[#ce9178]">'list'</span>] <span class="text-[#569cd6]">as const</span>,
  <span class="text-[#dcdcaa]">list</span>: (<span class="text-[#9cdcfe]">page</span>: <span class="text-[#4ec9b0]">Ref</span>&lt;<span class="text-[#4ec9b0]">number</span>&gt;, <span class="text-[#9cdcfe]">status</span>?: <span class="text-[#4ec9b0]">Ref</span>&lt;<span class="text-[#4ec9b0]">string</span>&gt;) <span class="text-[#569cd6]">=&gt;</span> [...<span class="text-[#4fc1ff]">userKeys</span>.<span class="text-[#dcdcaa]">lists</span>(), <span class="text-[#9cdcfe]">page</span>, <span class="text-[#9cdcfe]">status</span>] <span class="text-[#569cd6]">as const</span>,
}

<span class="text-[#6a9955]">// 2. Query Hook (ëª©ë¡ ì¡°íšŒ)</span>
<span class="text-[#c586c0]">export</span> <span class="text-[#569cd6]">const</span> <span class="text-[#dcdcaa]">useUserListQuery</span> = (<span class="text-[#9cdcfe]">page</span>: <span class="text-[#4ec9b0]">Ref</span>&lt;<span class="text-[#4ec9b0]">number</span>&gt;, <span class="text-[#9cdcfe]">status</span>?: <span class="text-[#4ec9b0]">Ref</span>&lt;<span class="text-[#4ec9b0]">string</span>&gt;) <span class="text-[#569cd6]">=&gt;</span> {
  <span class="text-[#c586c0]">return</span> <span class="text-[#dcdcaa]">useQuery</span>({
    <span class="text-[#9cdcfe]">queryKey</span>: <span class="text-[#4fc1ff]">userKeys</span>.<span class="text-[#dcdcaa]">list</span>(<span class="text-[#9cdcfe]">page</span>, <span class="text-[#9cdcfe]">status</span>), <span class="text-[#6a9955]">// ë°˜ì‘í˜• ë³€ìˆ˜ê°€ ë³€ê²½ë˜ë©´ ìë™ ì¬ìš”ì²­</span>
    <span class="text-[#dcdcaa]">queryFn</span>: () <span class="text-[#569cd6]">=&gt;</span> <span class="text-[#dcdcaa]">fetchUsers</span>(<span class="text-[#9cdcfe]">page</span>.value, <span class="text-[#9cdcfe]">status</span>?.value),
  })
}

<span class="text-[#6a9955]">// 3. Mutation Hook (ìƒì„±)</span>
<span class="text-[#c586c0]">export</span> <span class="text-[#569cd6]">const</span> <span class="text-[#dcdcaa]">useCreateUserMutation</span> = () <span class="text-[#569cd6]">=&gt;</span> {
  <span class="text-[#569cd6]">const</span> <span class="text-[#4fc1ff]">queryClient</span> = <span class="text-[#dcdcaa]">useQueryClient</span>()
  
  <span class="text-[#c586c0]">return</span> <span class="text-[#dcdcaa]">useMutation</span>({
    <span class="text-[#9cdcfe]">mutationFn</span>: <span class="text-[#dcdcaa]">createUser</span>,
    <span class="text-[#dcdcaa]">onSuccess</span>: () <span class="text-[#569cd6]">=&gt;</span> {
      <span class="text-[#6a9955]">// ìƒì„± ì„±ê³µ ì‹œ, ìºì‹œë¥¼ ë¬´íš¨í™”í•˜ì—¬ ëª©ë¡ í™”ë©´ì„ ìµœì‹ í™”í•©ë‹ˆë‹¤.</span>
      <span class="text-[#4fc1ff]">queryClient</span>.<span class="text-[#dcdcaa]">invalidateQueries</span>({ <span class="text-[#9cdcfe]">queryKey</span>: <span class="text-[#4fc1ff]">userKeys</span>.<span class="text-[#dcdcaa]">lists</span>() })
    },
    <span class="text-[#dcdcaa]">onError</span>: (<span class="text-[#9cdcfe]">error</span>) <span class="text-[#569cd6]">=&gt;</span> {
      <span class="text-[#6a9955]">// ì—ëŸ¬ ì²˜ë¦¬</span>
      <span class="text-[#9cdcfe]">console</span>.<span class="text-[#dcdcaa]">error</span>(<span class="text-[#ce9178]">'ìœ ì € ìƒì„± ì‹¤íŒ¨:'</span>, <span class="text-[#9cdcfe]">error</span>)
    }
  })
}</code></pre>
      </div>
    </section>

    <section class="space-y-4">
      <div class="flex items-center gap-2">
        <span class="bg-indigo-100 text-indigo-700 font-bold px-2 py-1 rounded text-sm"
          >STEP 3</span
        >

        <h3 class="text-xl font-bold text-gray-800">ì»´í¬ë„ŒíŠ¸ ì‚¬ìš© (Suspense & View Layer)</h3>
      </div>

      <p class="text-gray-600 text-sm">
        ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì—ì„œ <code>&lt;Suspense&gt;</code>ë¥¼ í†µí•´ ë¡œë”©ì„ ì¼ê´„ ì œì–´í•˜ê³ , ìì‹ì€
        <code>await suspense()</code>ë¥¼ í˜¸ì¶œí•˜ì—¬ ë°ì´í„°ë¥¼ ì¦‰ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
      </p>

      <div class="grid grid-cols-1 gap-6">
        <div class="bg-[#1e1e1e] rounded-lg shadow-xl border border-gray-800 font-mono text-sm">
          <div class="flex items-center px-4 py-2 bg-[#252526] border-b border-gray-800">
            <span class="text-gray-400 font-bold">Child Component</span>
            <span class="text-gray-500 ml-2">| src/components/UserList.vue</span>
          </div>

          <pre
            v-pre
            class="p-4 overflow-x-auto leading-relaxed text-[#d4d4d4]"
          ><code><span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">script</span> <span class="text-[#9cdcfe]">setup</span> <span class="text-[#9cdcfe]">lang</span>=<span class="text-[#ce9178]">"ts"</span><span class="text-[#808080]">&gt;</span>
<span class="text-[#c586c0]">import</span> { <span class="text-[#9cdcfe]">useUserListQuery</span> } <span class="text-[#c586c0]">from</span> <span class="text-[#ce9178]">'@/composables/queries/useUserQueries'</span>

<span class="text-[#569cd6]">const</span> <span class="text-[#4fc1ff]">page</span> = <span class="text-[#dcdcaa]">ref</span>(<span class="text-[#b5cea8]">1</span>)

<span class="text-[#6a9955]">// v-if="isLoading" ëŒ€ì‹ , ë°˜í™˜ëœ suspense() í•¨ìˆ˜ë¥¼ await í•©ë‹ˆë‹¤!</span>
<span class="text-[#6a9955]">// ì´ë¥¼ í†µí•´ ì»´í¬ë„ŒíŠ¸ê°€ ì¼ì‹œ ì •ì§€(Suspend) ë˜ë©° ë¶€ëª¨ì—ê²Œ ë¡œë”© ì œì–´ê¶Œì´ ë„˜ì–´ê°‘ë‹ˆë‹¤.</span>
<span class="text-[#6a9955]">// ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ìœ„í•´ isErrorì™€ error ê°ì²´ë„ í•¨ê»˜ ê°€ì ¸ì˜µë‹ˆë‹¤.</span>
<span class="text-[#569cd6]">const</span> { <span class="text-[#9cdcfe]">data</span>: <span class="text-[#4fc1ff]">users</span>, <span class="text-[#4fc1ff]">suspense</span>, <span class="text-[#4fc1ff]">isError</span>, <span class="text-[#4fc1ff]">error</span> } = <span class="text-[#dcdcaa]">useUserListQuery</span>(<span class="text-[#4fc1ff]">page</span>)

<span class="text-[#6a9955]">// [Component ì—ëŸ¬ ì²˜ë¦¬] ì—ëŸ¬ ë°œìƒ ì‹œ UIë¥¼ ì œì–´í•˜ê¸° ìœ„í•´ try-catchë¡œ ê°ìŒ‰ë‹ˆë‹¤.</span>
<span class="text-[#c586c0]">try</span> {
  <span class="text-[#c586c0]">await</span> <span class="text-[#dcdcaa]">suspense</span>()
} <span class="text-[#c586c0]">catch</span> (<span class="text-[#9cdcfe]">err</span>) {
  <span class="text-[#9cdcfe]">console</span>.<span class="text-[#dcdcaa]">error</span>(<span class="text-[#ce9178]">'ì»´í¬ë„ŒíŠ¸ ë‹¨ UI ì—ëŸ¬ ì²˜ë¦¬ ìˆ˜í–‰'</span>)
}
<span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">script</span><span class="text-[#808080]">&gt;</span>

<span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">template</span><span class="text-[#808080]">&gt;</span>
  <span class="text-[#6a9955]">&lt;!-- ğŸš¨ ì—ëŸ¬ ë°œìƒ ì‹œ ë³´ì—¬ì¤„ ì»´í¬ë„ŒíŠ¸ UI ë°©ì–´ ì½”ë“œ --&gt;</span>
  <span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">div</span> <span class="text-[#9cdcfe]">v-if</span>=<span class="text-[#ce9178]">"isError"</span> <span class="text-[#9cdcfe]">class</span>=<span class="text-[#ce9178]">"text-red-500"</span><span class="text-[#808080]">&gt;</span>
    ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {{ error?.message }}
  <span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">div</span><span class="text-[#808080]">&gt;</span>
  <span class="text-[#6a9955]">&lt;!-- ì•ˆì „í•˜ê²Œ ë°ì´í„°ë¥¼ ì¦‰ì‹œ ê·¸ë¦½ë‹ˆë‹¤. (isLoading ì²´í‚¹ ë¶ˆí•„ìš”) --&gt;</span>
  <span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">ul</span> <span class="text-[#9cdcfe]">v-else</span><span class="text-[#808080]">&gt;</span>
    <span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">li</span> <span class="text-[#9cdcfe]">v-for</span>=<span class="text-[#ce9178]">"user in users"</span> <span class="text-[#9cdcfe]">:key</span>=<span class="text-[#ce9178]">"user.id"</span><span class="text-[#808080]">&gt;</span>{{ user.name }}<span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">li</span><span class="text-[#808080]">&gt;</span>
  <span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">ul</span><span class="text-[#808080]">&gt;</span>
<span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">template</span><span class="text-[#808080]">&gt;</span></code></pre>
        </div>

        <div class="bg-[#1e1e1e] rounded-lg shadow-xl border border-gray-800 font-mono text-sm">
          <div class="flex items-center px-4 py-2 bg-[#252526] border-b border-gray-800">
            <span class="text-gray-400 font-bold">Parent Page</span>
            <span class="text-gray-500 ml-2">| src/pages/users/index.vue</span>
          </div>

          <pre
            class="p-4 overflow-x-auto leading-relaxed text-[#d4d4d4]"
          ><code><span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">script</span> <span class="text-[#9cdcfe]">setup</span> <span class="text-[#9cdcfe]">lang</span>=<span class="text-[#ce9178]">"ts"</span><span class="text-[#808080]">&gt;</span>
<span class="text-[#c586c0]">import</span> <span class="text-[#9cdcfe]">UserList</span> <span class="text-[#c586c0]">from</span> <span class="text-[#ce9178]">'@/components/UserList.vue'</span>
<span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">script</span><span class="text-[#808080]">&gt;</span>

<span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">template</span><span class="text-[#808080]">&gt;</span>
  <span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">div</span><span class="text-[#808080]">&gt;</span>
    <span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">h1</span><span class="text-[#808080]">&gt;</span>ì‚¬ìš©ì ëª©ë¡ ê´€ë¦¬<span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">h1</span><span class="text-[#808080]">&gt;</span>
    
    <span class="text-[#6a9955]">&lt;!-- ë¹„ë™ê¸° ì»´í¬ë„ŒíŠ¸ì˜ ë¡œë”© ìƒíƒœë¥¼ ì—¬ê¸°ì„œ ì¼ê´„ ì œì–´í•©ë‹ˆë‹¤. --&gt;</span>
    <span class="text-[#808080]">&lt;</span><span class="text-[#4ec9b0]">Suspense</span><span class="text-[#808080]">&gt;</span>
      <span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">template</span> <span class="text-[#9cdcfe]">#default</span><span class="text-[#808080]">&gt;</span>
        <span class="text-[#808080]">&lt;</span><span class="text-[#4ec9b0]">UserList</span> <span class="text-[#808080]">/&gt;</span>
      <span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">template</span><span class="text-[#808080]">&gt;</span>

      <span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">template</span> <span class="text-[#9cdcfe]">#fallback</span><span class="text-[#808080]">&gt;</span>
        <span class="text-[#808080]">&lt;</span><span class="text-[#569cd6]">div</span> <span class="text-[#9cdcfe]">class</span>=<span class="text-[#ce9178]">"animate-pulse bg-gray-200 h-32 rounded"</span><span class="text-[#808080]">&gt;</span>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...<span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">div</span><span class="text-[#808080]">&gt;</span>
      <span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">template</span><span class="text-[#808080]">&gt;</span>
    <span class="text-[#808080]">&lt;/</span><span class="text-[#4ec9b0]">Suspense</span><span class="text-[#808080]">&gt;</span>
  <span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">div</span><span class="text-[#808080]">&gt;</span>
<span class="text-[#808080]">&lt;/</span><span class="text-[#569cd6]">template</span><span class="text-[#808080]">&gt;</span></code></pre>
        </div>
      </div>
    </section>
  </div>
</template>
